<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>D3 Donut Chart with Manual Annotations</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&display=swap');

        body {
            font-family: Arial, sans-serif;
        }

        .annotation-line {
            stroke: black;
            stroke-width: 1px;
        }

        .annotation-text {
            font-size: 12px;
            fill: black;
            position: absolute;

        }

        /* Optional: Style the chart container */
        #chart {
            width: 600px;
            margin: auto;
        }
    </style>
</head>

<body>
    <p>lorem</p>

    <div class="container">
        <div class="row">
            <div class="col">
                <div class="chart-container">
                    <div id="chart1"></div>
                </div>
            </div>
            <div class="col">
                <div class="chart-container">
                    <div id="chart2"></div>
                </div>
            </div>
            <div class="col">
                <div class="chart-container">
                    <div id="chart3"></div>
                </div>
            </div>
        </div>
    </div>



    <script>

        function drawChart(id, data) {

            const container = d3.select(`#${id}`);
            const width = parseInt(container.style('width'));
            const height = width;
            const margin = { top: 20, right: 20, bottom: 20, left: 20 };
            const radius = Math.min(width, height) / 2 - Math.max(margin.top, margin.right);

            // Set color scale
            const color = d3.scaleOrdinal()
                .domain(data.map(d => d.label))
                .range(['#1f77b4', '#ff7f0e']);

            // Check if SVG exists
            let svg = container.select('svg');
            if (svg.empty()) {
                // Create SVG element
                svg = container
                    .append('svg')
                    .attr('width', '100%')
                    .attr('height', '100%')
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .attr('preserveAspectRatio', 'xMinYMin meet')
                    .append('g')
                    .attr('transform', `translate(${width / 2}, ${height / 2})`);
            } else {
                svg = svg.select('g');
                svg.attr('transform', `translate(${width / 2}, ${height / 2})`);
            }

            // Generate the pie
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null);

            // Generate the arcs
            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius);

            // Bind data to arcs
            const arcs = svg.selectAll('.arc')
                .data(pie(data), d => d.data.label);

            // Handle exit selection
            arcs.exit().remove();

            // Handle enter selection
            const arcsEnter = arcs.enter()
                .append('g')
                .attr('class', 'arc')
                .attr('class', d => d.data.label.replace(/\s+/g, '-').toLowerCase());

            arcsEnter.append('path')
                .attr('fill', d => color(d.data.label))
                .each(function (d) { this._current = d; })
                .attr('d', arc);

            // Merge enter and update selections
            const arcsMerge = arcsEnter.merge(arcs);

            // Update existing arcs
            arcsMerge.select('path')
                .transition()
                .duration(750)
                .attrTween('d', function (d) {
                    const interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(1);
                    return t => arc(interpolate(t));
                });

            // Update points
            arcsMerge.each(function (d) {
                const numPoints = 5;

                // Generate points data
                const pointsData = [];
                for (let i = 1; i <= numPoints; i++) {
                    const t = i / (numPoints + 1);
                    const angle = d.startAngle + t * (d.endAngle - d.startAngle);
                    const innerRadius = arc.innerRadius()(d);
                    const outerRadius = arc.outerRadius()(d);
                    const middleRadius = (innerRadius + outerRadius) / 2;
                    const x = middleRadius * Math.cos(angle - Math.PI / 2);
                    const y = middleRadius * Math.sin(angle - Math.PI / 2);
                    pointsData.push({ x, y });
                }

                // Select the points group or create it if it doesn't exist
                let pointsGroup = d3.select(this).select('.points-group');
                if (pointsGroup.empty()) {
                    pointsGroup = d3.select(this).append('g').attr('class', 'points-group');
                }

                // Bind points data to circles
                const circles = pointsGroup.selectAll('circle')
                    .data(pointsData);

                // Handle exit selection
                circles.exit().remove();

                // Handle enter selection
                circles.enter()
                    .append('circle')
                    .attr('class', (d,i) => `point-${i}`)
                    .attr('r', 0)
                    .attr('fill', '#000')
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                // Update existing circles
                circles.transition()
                    .duration(750)
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
            });
        }


        function add_label(chart, slice_id, point_id, hour, anchor, text, line_config = {}, text_config = {}) {

            
            let line_config_set = {
                class_name: line_config.class_name ? line_config.class_name : '', 
                length: line_config.length ? line_config.length : 80,
                color: line_config.color ? line_config.color : 'black',
                thickness: line_config.thickness ? line_config.thickness : 1
            }


            let text_config_set = {
                class_name: text_config.class_name ? text_config.class_name : '',
                color: text_config.color ? text_config.color : 'black',
                align: text_config.align ? text_config.align : 'left'
            }
            
            // get the boundingbox of the point
            let point = d3.select(`#${chart} .${slice_id} .point-${point_id}`);

            // get the boundingrect of the point
            let point_rect = point.node().getBoundingClientRect();

            console.log(point_rect);

           // Existing line code
            let angleDeg = (hour * 30) - 90; 
            let length = line_config_set.length; 
            let angleRad = angleDeg * (Math.PI / 180); 
            let dx = length * Math.cos(angleRad);
            let dy = length * Math.sin(angleRad);
            let endX = point_rect.left + dx;
            let endY = point_rect.top + dy;

            let anchors = {
                'tl': '0%, 0%',
                'tc': '-50%, 0%',
                'tr': '-100%, 0%',
                'bl': '0%, -100%',
                'bc': '-50%, -100%',
                'br': '-100%, -100%'
            }; 

            // Append the line
            d3.select('body').append('div')
                .attr('class', 'annotation-line')
                .attr('class', line_config_set.class_name)
                .style('top', `${point_rect.top}px`)
                .style('left', `${point_rect.left}px`)
                .style('width', `${line_config_set.length}px`)
                .style('height', `${line_config_set.thickness}px`)
                .style('background-color', line_config_set.color)
                .style('position', 'absolute')
                .style('transform-origin', 'top left')
                .style('transform', `rotate(${angleDeg}deg)`);

            // Calculate text position with offset
            let textOffset = 5; 
            let textX = endX + textOffset * Math.cos(angleRad);
            let textY = endY + textOffset * Math.sin(angleRad);

            // Append the text
            d3.select('body').append('div')
                .attr('class', text_config_set.class_name)
                .attr('class', 'annotation-text')
                .style('position', 'absolute')
                .style('left', `${textX}px`)
                .style('top', `${textY}px`)
                .style('transform', `translate(${anchors[anchor]})`)
                .style('text-align', text_config_set.align)
                .html(text);
        }

       



        
        let data = [
            { label: 'Category A', value: 30 },
            { label: 'Category B', value: 70 }
        ];

        
        drawChart('chart1', data);
        drawChart('chart2', data);
        drawChart('chart3', data);

        
        /*setTimeout(() => {
            data = [
                { label: 'Category A', value: 50 },
                { label: 'Category B', value: 50 }
            ];

            drawChart('chart1', data);
        }, 2000)*/

        add_label('chart1', 'category-b', 4, 11, 'tr', 'text here<br/>how are you?', {}, {align: 'right'});
        add_label('chart2', 'category-b', 2, 7, 'tr', 'text here<br/>how are you?', {}, {align: 'right'});
        add_label('chart3', 'category-a', 4, 4, 'tl', 'text here<br/>how are you?', {}, {});


    </script>
</body>

</html>